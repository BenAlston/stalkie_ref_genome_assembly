
# **Stalkie Reference Genome Assembly**
* This pipeline _will_ generate reference genomes for _Teleopsis dalmanni_, _Teleopsis whitei_ and _Diasemopsis meigenii_. PacBio HiFi data for assembly, Omni-C for Scaffolding, and RNA ISO-seq for annotation.
From [Alex's pipeline](https://github.com/alexjvr1/T.dalmanni_Genomics_of_meiotic_drive/blob/main/Electronic_Lab_Book.md#1-genome-assembly), we know the current _T. dalmanni_ ref is ~0.383 Gb and 3 chromosomes 

### Overview of pipeline: 
![pipeline_1.png](https://github.com/BenAlston/stalkie_ref_genome_assembly/blob/main/lab_book/figures/pipeline1.png)

### Samples & data
  ~~~
  - sequence data for 6 individuals, 1M, 1F per species.
  - Assemblies should be generated for each sex, so 6 ssemblies total, enabling sex chromosome identification
  - Two HiFi .fastq.gz files per individual
  ~~~

# 1. **Genome Size Estimation with Jellyfish**
* [Jellyfish v2.2.10](https://github.com/gmarcais/Jellyfish)
* Ran [jellyfish.sh](https://github.com/BenAlston/stalkie_ref_genome_assembly/blob/main/scripts/jellyfish.sh) on each species
* Used [genomescope](http://qb.cshl.edu/genomescope/) to visualise the .histo files generated by jellyfish (read length=10000, max kmer coverage=100000)
* [genomescope plots](https://github.com/BenAlston/stalkie_ref_genome_assembly/tree/main/lab_book/Data/jellyfish_histos%20)


# 2. **Assembly with Hifiasm**
* [hifiasm v0.16.1-r375](https://github.com/chhylp123/hifiasm)
* Ran [hifiasm.sh](https://github.com/BenAlston/stalkie_ref_genome_assembly/blob/main/scripts/hifiasm.sh) (Hifiasm V 0.16.1), takes ~10-12 hrs
* Made hifiasm_hic.sh, for when Omni-C arrives

## incorporating Hi-C
* hifiasm is able to integrate Hi-C directly into the assembly, but lots of manual curration is still needed
* going to run all on the tdal ref for simplicity


### **BUSCO**
* Ran [busco.sh](https://github.com/BenAlston/stalkie_ref_genome_assembly/blob/main/scripts/busco.sh), takes ~10-20 mins
* See [busco output](https://github.com/BenAlston/stalkie_ref_genome_assembly/tree/main/lab_book/Data/BUSCO_output)
* duplication looks very high across the board, not very contiguous, also a lot larger than expected

**Table 1:** Assembly number corresponds with the identifier in the hifi read filenames (e.g., assembly 6 is derived from 200437_6-Cell1, which contains _T. dalmanni_ male reads). Est size from jellyfish.
| species | assembly | info         | est_size         | primary_assembly_size | busco_completeness | busco_dup | contigs | N50 (Kb) |
|-----|-----|-----------------|------------------|-----------------------|--------------------|-----------|---------|-----|
| whitei | 1 | female       |        597436869 | 761502157             | 95.8               | 35.6      | 7589    | 156 |
| whitei | 2 | male       | 424970908        | 730392625             | 95.1               | 25.6      | 6466    | 178 |
| meigenii| 4 | female      |        694112101 | 694692253             | 96.4               | 28.6      | 3136    | 463 |
| meigenii| 5 | male     | 477607885        | 742331081             | 96.3               | 16.9      | 3064    | 576 |
| meigenii| 5 | male, ran with -k 19 | 477607885 | 716000585 | 96.4 | 12.6 | 2816 | 587 |
| dalmanni| 6 | male       | 657136228        | 700361654             | 97.8               | 25.7      | 2913    | 687 |
|dalmanni | 7 | female       |        533280821 | 609130602             | 97.3               | 4.9       | 2425    | 998 |

### **Checking Coverage is as Expected**
* Check hifiasm correctly identifies the homozygous and heterozygous peaks in the kmer plots, compare this to the jellyfish kmer plots as a sanity check.
  - This is true for meigenii_4, dalmanni_7
* Issue with meigenii_5 and dalmanni_6:  "peak_hom: 23; peak_het: -1"
  - [see this thread](https://github.com/chhylp123/hifiasm/issues/245), potentially caused by the sample being highly heterozygous. Hifiasm only identifies one peak (the het peak) and misidentifies it as the hom peak. For meigenii_5, it should be "peak_het: 23, peak_hom: 46"
  - This can be fixed by specifying -k 19 (kmer length, default 51, must be <64)
  - this fix makes the script take ages to run, and for some samples may require too much memory, also [this person](https://github.com/chhylp123/hifiasm/issues/55) found that doing this made hifiasm output both haplotypes into the primary assembly, leaving a too small alternate assembly - make sure it isn't doing this.
  - Also no indication as to why they chose this kmer length 


# 3. Cleaning Assemblies
* Remove contamination using blobtoolkit, then remove duplicated haplotigs using purge_dups

## **Filtering Contamination with Blobtoolkit**
* [Blobtoolkit v3.1.6 ](https://github.com/blobtoolkit/blobtoolkit)
* Essentially takes blast output, coverage, and busco output, and filters the dataset for contamination
* Needs:
  - blast.out file (generated in [blast_par.sh](https://github.com/BenAlston/stalkie_ref_genome_assembly/tree/main/scripts/blobtoolkit/blast_par.sh))
  - coverage (generated in [blobtoolkit.sh](https://github.com/BenAlston/stalkie_ref_genome_assembly/edit/main/scripts/blobtoolkit/blobtoolkit.sh))
  - busco (generated in [busco.sh](https://github.com/BenAlston/stalkie_ref_genome_assembly/tree/main/scripts/utility/busco.sh))

### **Blast**

**Installing local blast database**
* Remote searches are not feasible for large queries, so installed the local Blast nt db ([using blast_nt_db.sh](https://github.com/BenAlston/stalkie_ref_genome_assembly/blob/main/scripts/blobtoolkit/blast_nt_db.sh)), this takes up ~450GB of space
* Even with the local blast nt db, blasting my highly contiguous assemblies will take too long unless it is parallelised

**Parallelising Blast**
* Split my assembly fasta into 500 smaller files: ran [fasta_splitter.sh](https://github.com/BenAlston/stalkie_ref_genome_assembly/blob/main/scripts/blobtoolkit/fasta_splitter.sh)
* ran blast on each using an array script, [blast_par.sh](https://github.com/BenAlston/stalkie_ref_genome_assembly/blob/main/scripts/blobtoolkit/blast_par.sh)
* Then I condensed these blast output files into a single file:
~~~
cat out/* >> all_blast.out
~~~

## **Blobtoolkit pipeline:**
* Ran [blobtoolkit.sh](https://github.com/BenAlston/stalkie_ref_genome_assembly/edit/main/scripts/blobtoolkit/blobtoolkit.sh)
* This script calculates coverage, takes the blast output I just generated, and the busco output from [busco.sh](https://github.com/BenAlston/stalkie_ref_genome_assembly/edit/main/scripts/utility/busco.sh). It then filters the assembly for contamination, I am able to specify which taxanomic rank blast matches I want removed.
* **Important: generating coverage using minimap2 does not work for dalmanni_6, this is likely an issue to to with the HiFi reads being to long.**
* This analysis has currently been run on whitei_1 and whitei_2 only.

#### **Setting Filter Parameters**
* Need to select appropriate taxanomic level to filter
* The below table was generated with: --param bestsum_$clade_rank--keys=no-hit,$clade # this keeps only reads with blast hits from that clade, and reads with no blast hits

| Clade      | Size (Gb) | Contigs | Completeness | Duplication|
|------------|-----------|---------|--------------|------------|
| Unfiltered | 0.762     | 7598    | 95.8         | 35.6       |
| Eukaryota  | 0.748     |  7481   | 95.7         | 35.6       |
| Metazoa    | 0.742     | 7368    | 95.6         | 35.5       |
| Arthropoda | 0.742     | 7363    | 95.6         | 35.5       |
| Diptera    | 0.715     | 6933    | 95.3         | 35.3       | 

* Metazoan and no blast matches seem to be the most sensible contigs to retain.

## **Purge Dups**
* [purge_dups v1.2.5](https://github.com/dfguan/purge_dups)
* Purges haplotigs using coverage and sequence similarity info
* First running this pipeline on whitei F (sample 1) since its busco dup is 35%
* Runing the pipeline manually to have more control over the parameters.

**Manual pipeline**
whitei_1 pre and post purge_dups_manual.sh
|              | length (gb) | contigs | dup (%)| Conpleteness (%) | n50 (kb) |
| -------------|-------------|---------|--------|------------------|----------|
| pre-purging  | 0.762 | 7589   |  35.6|   95.8         | 156 |
| purge_dups round 2 (default cutoffs) | 0.548    | 4718      | 2.5    | 94.5     | 187 |
| purge_dups round 2 (manual cutoffs) | 0.553 | 4755 | 2.9 | 94.6 | 188 |

* Manual cutoffs male a slightly better assembly, but it's pretty marginal, it would be nice is busco completeness was above 95%, I could increase the upper cuttoff until i hit this.
* I reckon the default settings are generally fine, but I will sanity check the histogram and adjust if neccessary.
![PB_1 cov](https://github.com/BenAlston/stalkie_ref_genome_assembly/assets/159305266/240949cb-0eae-4b67-a478-9ecd0d1e9c4a)
* Default cutoffs seem sensible, valley between het and hom peaks has been identified, but I am unsure if the upper and lower cutoffs are in the correct places

# 4. Trying Different Assemblers
* Trying different assemblers to see if these work better for my data
* wtdbg2/2.5 (redbean), canu/2.2, flye/2.9.4

| assembler  | species  | sample_prefix | sex    | jellyfish_est_size_gb | primary_assembly_size_gb | busco_completeness | busco_dup | contigs | N50_mb |
|------------|----------|---------------|--------|-----------------------|--------------------------|--------------------|-----------|---------|--------|
| hifiasm    | dalmanni | 7             | female | 0.533                 | 0.609                    | 97.3               | 4.9       | 2425    | 0.998  |
| redbean    | dalmanni | 7             | female | 0.533                 | 0.510                    | 96.5               | 1.1       | 3741    | 0.673  |
| flye_draft | dalmanni | 7             | female | 0.533                 | 0.760                    | 95.6               | 38.0      | 3067    | 0.568  |
| flye_final | dalmanni | 7             | female | 0.533                 | 2.119                    | 16.8               | 4.5       | 2524    | 1.741  |
| canu       | dalmanni | 7             | female | 0.533                 | 0.017                    | 2.3                | 0.1       | 872     | 0.019  |




